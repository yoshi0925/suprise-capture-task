<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://psyc241.ucsd.edu/Chaipat/TB_PCL_vWM_2AFC/js/vismemCC.js"></script>
<script src=""></script>

<style>
  .trialDiv {
    /* border: 2px solid gray;*/
    border: 0px;
    padding: auto;
    width: auto;
    position: relative;
    top: 50px;
    left: 50%;
    /* bring your own prefixes */
    transform: translate(-50%, -50%);
    text-align: center;
    display: none;
  }

  body {
    font-family: Arial, Helvetica;
    font-size: 12pt;
  }
  #nextButton {
    display: none;
  }
  #submitButton {
    display: none;
  }

  #instructions {
    width: 60%;
    margin: 0 auto;
    text-align: center;
    margin-top: 100px;
  }

  #startExperiment {
    color: rgb(200, 200, 200);
    text-decoration: none;
  }

  #startExperiment:hover {
    color: white;
  }

  #startExperimentButton {
    width: 200px;
    text-align: center;
    border: 4px outset gray;
    background: gray;
    padding: 5px;
    margin: 0 auto;
  }

  #meter {
    width: 10cm;
    height: 10cm;
  }

  .instr {
    display: none;
  }

  .center-div {
    position: absolute;
    margin: auto;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    width: 320px;
    height: 100px;
  }

  #save {
    display: none;
  }
  #done {
    display: none;
  }

</style>

<div id="save" class="top-div">
  Saving data...
</div>
<div id="done" class="center-div">
  Done!
</div>

<input type="submit" value="Submit" name="submitButton" id="submitButton" style="position: absolute; margin: auto; top: 0; right: 0; bottom: 0; left: 0; width: 50px; height: 100px;" onclick="Saved()">
<input type="submit" value="Submit" name="submitButton0" id="submitButton0" style="position: absolute; margin: auto; top: 0; right: 0; bottom: 0; left: 0; width: 50px; height: 100px; display: none;" onclick="Saved()">

<div id="instructions">
  <h2> Reaction Time Test </h2>
  <p>

    <p> <b> To proceed, please go fullscreen and your screen need to be bigger than 400 pixels </b>
      <br> Press <b>F11</b> to go full screen on a Windows PC
    </p>
    <p style="font:5px"> Clicking on the button will indicate that you have read this consent document and agree to participate. </p>

    <div id="startExperimentButton">
      <a href="#" id="startExperiment">I agree</a>
    </div>
    <p></p>

    <div id="consent" style="height:300px; border:1px solid #ccc;font:12px Arial, Helvetica; overflow:auto" align="justify">
      <p align="center"><b>UNIVERSITY OF CALIFORNIA, SAN DIEGO
          <br>CONSENT TO ACT AS A RESEARCH SUBJECT</b>

        <p> Dr. John Serences is conducting a research study to learn more about how attention affects how you see things
          (perception) and how you make simple decisions. There will be approximately 5,000 participants in the study
          over the next 10 years.</p>

        <p>
          <br><b>PROCEDURES.</b> If you agree to be in this study by clicking “Agree” and continuing to this task, the following
          will happen to you: You will be presented with stimuli that consist of simple shapes presented on a computer
          screen. You will respond with button presses and/or using your computer mouse.
          <p>
            <br> <b>RISKS.</b> You will be required only to continue to interact with your web browser and make responses for a short
            duration. Thus, no potential risks or discomforts are anticipated except for the possibility that some tasks may
            be slightly boring. However, there may be risks that are currently unforeseeable.</p>

          <p>
            <br><b>REMUNERATION.</b> In consideration of your time and effort you will receive extra course credit for your
            participation via the SONA system (0.5 credits per 30 minutes, rounded up to the nearest 30-minute increment).</p>

          <p>
            <br><b>RIGHTS.</b> If you are injured as a direct result of participation in this research, the University of California will
            provide any medical care you need to treat those injuries. The University will not provide any other form of
            compensation to you if you are injured. You may call the Human Research Protections Program at 858-246-
            4777 for more information about this, to inquire about your rights as a research subject, or to report research-
            related problems.</p>

          <p>
            <br><b>BENEFITS.</b> There will be no direct benefit to you from these procedures. However, the investigator may learn more about basic questions pertaining to attention, memory and vision. This knowledge may have benefits to society in
            fields
            ranging from improving education to visual design, but these benefits will be indirect.</p>

          <p>
            <br><b>EXPLANATION.</b> Dr. John Serences or a member of his research team has explained this study to you and
            answered your questions. If you have other questions or research-related problems, you may reach him at 858-
            534-3686. </p>
          <p>
            <br><b>VOLUNTARY NATURE OF PARTICIPATION.</b> Participation in this research is entirely voluntary. There is
            no cost to you for participating. The alternative to participating is not participating. You may refuse to
            participate or you may withdraw at any time without jeopardy to the medical care you will receive at this
            institution, without loss of any access to the care to which you are entitled, or loss of the benefits to which you
            are entitled. You may also be withdrawn from the study if the investigator feels it is in your best interest or for
            other study-related purposes. If you wish to withdraw from the study tell a member of the study staff and the
            testing session will terminate immediately. You will be compensated for the time you have spent.</p>

          <p>
            <br><b>CONFIDENTIALITY.</b> Research records will be kept confidential to the extent provided by law. Research
            records will only be accessible by Dr Serences and his research team, and by the UCSD Institutional Review
            Board. You have received a copy of this consent document.</p>

          <p>
            <br>By clicking “I agree”, you are indicating that you are at least 18 years old, have read this consent form and agree to participate in this research study. Please print a copy of this page for your records.</p>
        </p>
    </div>
</div>

<div id='frame6' ; class='trialDiv'>
  <p>
    <br> Demo start!!!
    <br> <br> Please press <b>space</b> to continue.</p>
</div>


<!-- Trial Page -->
<div id='hor_ver' ; class='trialDiv'>
  <p>
    <br> Press 'Z' for horizontal, 'M' for vertical.</p>
</div>

<div id="progressReport" ; class='trialDiv'>
  Trial <span id="trialNumber">1</span> of <span id="totalTrialNumber">50</span>;
  <!-- THIS NUMBER WILL NEED TO BE CHANGED IF THE NUMBER OF TRIALS CHANGES -->
</div>

<div id="fill" ; class='trialDiv'>
  <p>
    <br> Please fill all fields.</p>
</div>

<!-- Survey -->
<section class="container" id="Survey" style="margin-bottom:15px; padding: 10px 10px; font-family: Verdana, Geneva, sans-serif; color:#333333; font-size:0.9em;">

  <div class="row col-xs-12 col-md-12"><!-- Instructions -->

    <div class="panel panel-primary">

      <div class="panel-heading"><strong>Race and Ethnicity Form (!YOU MUST HIT SAVE BUTTON FOR SONA CREDIT!) </strong></div>

      <div class="panel-body">

        <p>Please fill out the following demographics survey before you submit your results. If choosing to not report, please select "Unknown or not reported".</p>

      </div>

    </div>
    <!-- End Instructions -->
    
    <!-- Survey Body -->

    <section>
      <fieldset>
          <label>1. What is your gender? </label>

        <div class="radio">
          <label>
            <input name="Gender" type="radio" value="Male" />Male
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Gender" type="radio" value="Female" />Female
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Gender" type="radio" value="Other" />Non-binary or Other
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Gender" type="radio" value="NoResponse" />Unknown or not reported
          </label>
        </div>

      </fieldset>

      <fieldset>
        <label>2. Which ethnicity best describes you? </label>

        <div class="radio">
          <label>
            <input name="Ethnicity" type="radio" value="Hispanic/Latino" />Hispanic or Latino
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Ethnicity" type="radio" value="NonHispanic" />Not Hispanic or Latino
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Ethnicity" type="radio" value="NoResponse" />Unknown or not reported
          </label>
        </div>

      </fieldset>

      <fieldset>
        <label>3. Which race best describes you? (Please choose only one) </label>

        <div class="radio">
          <label>
            <input name="Race" type="radio" value="AmericanIndian" />American Indian or Alaskan Native
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Race" type="radio" value="Asian" />Asian
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Race" type="radio" value="PacificIslander" />Pacific Islander
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Race" type="radio" value="Black" />Black or African American
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Race" type="radio" value="White" />White/Caucasian
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Race" type="radio" value="MoreThanOne" />More Than One Race
          </label>
        </div>

        <div class="radio">
          <label>
            <input name="Race" type="radio" value="NoResponse" />Unknown or not reported
          </label>
        </div>

      </fieldset>

    </section>
    
    <section>
   		 <form id="age_form">
          <strong>Enter a number for your age: <input type="number" id="ageNumber" name="ageNumber"></strong><br>
        </form>
    </section>
    
      <!-- End Survey Body -->


    <div class="row col-xs-12 col-md-12" ><!-- Instructions -->

      <div class="panel panel-primary">

        <div class="panel-heading"><strong>Instructions</strong></div>

        <div class="panel-body">

          <p>Please look at the picture below, and enter the number that you see in the corresponding boxes</p>

        </div>

      </div>
      <!-- End Instructions --><!-- Test Body -->
      <div id="test_pic" style="float: left; clear: both; margin: 50px 0px 0px 0px;">
        <form id="number_form">
          <strong>Enter the number in the picture: <input type="number" id="testNumber" name="testNumber"></strong><br>
        </form>
      </div>

      <button type="next" id="testButton" value="Next" onclick="checkValue()">Save</button>
    </div>

  <!-- End Test Body -->
  </div>
</section>
<!-- close container -->

<div id='pic' ; style="float: left; clear: both; margin: 50px 0px 0px 0px;">
</div>

<!--Beginning of javascript code-->
<script>
  $('#startExperiment').click(demoSeparateByCanvas);
  $('.trialDiv').hide();
  $("#Survey").hide();

  // Global variables
  // vars not defined from imported js
  var isTrain = 0;
  var isTest = 0;
  var moveLast = 0;
  function endTime(){
    return 160;
  }
  var currProbe = 1;

  const Lkey = 122;
  const Rkey = 109;
  const placeHolderKey = 45; // the `ins` key, use to hack the 3-sec constraint
  var timeToRespond = false; //this indicates whether or not the subject is allowed to respond with 'same' or 'different'
  var timeToMoveOn = true; //this indicates whether or not the subject is allowed to move on to the next trial

  const green_circle_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_circle_hor.png";
  const green_circle_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_circle_ver.png";
  const green_rec_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_rec_hor.png";
  const green_rec_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_rec_ver.png";
  const red_circle_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_circle_hor.png";
  const red_circle_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_circle_ver.png";
  const red_rec_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_rec_hor.png";
  const red_rec_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_rec_ver.png";
  const green_canvas = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_canvas.png";
  const red_canvas = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_canvas.png";
  const dot = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/900px-Maya_1.svg.png";
  const color_blind_test = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/colorblind-test.jpg";

  const arr_g = [green_rec_hor, green_rec_ver];
  const arr_r = [red_rec_hor, red_rec_ver];
  const arr_c = [green_canvas, red_canvas];

  const sleep_time = 1000;

  const arr_loc = ['top', 'mid_left', 'mid_right', 'bot_left', 'bot_right'];

  const arr_g_remaining = [green_circle_ver, green_circle_hor];
  const arr_r_remaining = [red_circle_ver, red_circle_hor];

  // same color mode run 50 times
  const ctr_same_color = 2;
  var trial_num = 1;
  var system_idx = 4; 

  //display_list to save the generated answere, res_list is the human answer
  var res_list = [];
  var res_time = [];
  var display_list = [];
  var canvas_list = [];
  var surprise_list = [];
  var res = "";

  var index = 0;

  // flags for random cases organization
  var g_flag = false;
  var r_flag = false;
  var mix_flag = false;

  // preload the images
  const imgSrcArr = [
    green_circle_hor,
    green_circle_ver,
    green_rec_hor,
    green_rec_ver,
    red_circle_hor,
    red_circle_ver,
    red_rec_hor,
    red_rec_ver,
    red_canvas,
    green_canvas,
    dot,
    color_blind_test
  ];

  var createdTime = 0;
  var clickedTime = 0;

  var imgWrap = [];

  //timing controller
  var controller = false;
  var canvas_emit_controller = false;

  //survey vars
  var v1 = "";
  var v2 = "";
  var v3 = "";
  var v4 = "";
  var v5 = "";
  var if_fill = true;

  var dataToServer={}

  function preloadImg(arr) {
    for (var i = 0; i < arr.length; i++) {
      imgWrap[i] = new Image();
      imgWrap[i].src = arr[i];
    }
  }

  preloadImg(imgSrcArr);

  //ms: millie seconds you want to sleep
  //usage: await sleep(sleep_time) in an async function
  //const sleep_time is defined above at the global var section
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function show_image(src, width, height, direction) {
    var img = document.createElement("img");
    img.src = src;
    switch (direction){
      case "top":
        img.style = "position: absolute; top: 100px; left: 600px;";
        break;
      case "mid_right":
        img.style = "position: absolute; top: 300px; left: 300px;";
        break;
      case "mid_left":
        img.style = "position: absolute; top: 300px; left: 900px;";
        break;
      case "bot_left":
        img.style = "position: absolute; top: 550px; left: 450px;";
        break;
      case "bot_right":
        img.style = "position: absolute; top: 550px; left: 750px;";
        break;
      case "center":
        img.style = "position: absolute; top: 350px; left: 600px;";
        break;
      case "test_pic":
        img.style = "position: absolute; top: 600px; left: 20px;";
        break;
      case "canvas":
        img.style = "position: absolute; top: 250px; left: 325px;";
        break;
      default:
        var e = new Error('image location error, please check render codes');
        throw e;
    }
    img.width = width;
    img.height = height;

    // This next line will just add it to the <div id='pic'> tag
    var pic_div = document.getElementById('pic');
    pic_div.appendChild(img);

  }

  function clean_image() {
    var div = document.getElementById('pic');
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
  }

  function get_survey_value(str){
  	var radio = document.getElementsByName(str);
  	for (i=0; i<radio.length; i++) {
  		if (radio[i].checked) {
  			return(radio[i].value)
  		}
  	}
  }

  function rand_canvas(){
    let tar_canvas = arr_c[Math.floor(Math.random() * 2)];
    // if( !canvas_emit_controller ){
    //   canvas_emit_controller = true;
    //   return;
    // }
    show_image(tar_canvas, 800, 450, 'canvas');
    let canvas_data = tar_canvas.match(/green_canvas|red_canvas/g);
    canvas_list.push(canvas_data);
  }


  async function rand_red() {
    clean_image();
    controller = false;

    if(canvas_emit_controller){
      show_image(dot, 250, 250, 'center');
      await sleep(sleep_time);

      rand_canvas();
      await sleep(2 * sleep_time);
      clean_image();
    }else{
      canvas_emit_controller = true;
    }

    show_image(dot, 250, 250, 'center');
    await sleep(sleep_time);

    clean_image();
    show_image(dot, 250, 250, 'center');

    var tar_pic = arr_r[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];
    var temp_list = [];

    var res_data = "rand_red@" + tar_loc + "@" + tar_pic.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
    temp_list.push(res_data);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    for (let i = 0; i < arr_loc_remaining.length; i++) {
      var p = arr_r_remaining[Math.floor(Math.random() * 2)];
      var l = arr_loc_remaining[i];

      var temp_data = "rand_red@" + l + "@" + p.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
      temp_list.push(temp_data);

      show_image(p, 250, 250, l);
    }
    display_list.push(temp_list.sort());

    controller = true;
    createdTime = Date.now();
  }

  async function rand_green() {
    clean_image();
    controller = false;

    if(canvas_emit_controller){
      show_image(dot, 250, 250, 'center');
      await sleep(sleep_time);

      rand_canvas();
      await sleep(2 * sleep_time);
      clean_image();
    }else{
      canvas_emit_controller = true;
    }

    show_image(dot, 250, 250, 'center');
    await sleep(sleep_time);

    clean_image();
    show_image(dot, 250, 250, 'center');

    var tar_pic = arr_g[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];
    var temp_list = [];

    var res_data = "rand_green@" +  tar_loc + "@" + tar_pic.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
    temp_list.push(res_data);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    for (let i = 0; i < arr_loc_remaining.length; i++) {
      var p = arr_g_remaining[Math.floor(Math.random() * 2)];
      var l = arr_loc_remaining[i];

      var temp_data = "rand_green@" + l + "@" + p.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
      temp_list.push(temp_data);

      show_image(p, 250, 250, l);
    }
    display_list.push(temp_list.sort());

    controller = true;
    createdTime = Date.now();
  }

  async function rand_red_in_green() {
    clean_image();
    controller = false;

    show_image(dot, 250, 250, 'center');
    await sleep(sleep_time);
    clean_image();

    rand_canvas();
    await sleep(2 * sleep_time);
    clean_image();

    show_image(dot, 250, 250, 'center');
    await sleep(sleep_time);

    clean_image();
    show_image(dot, 250, 250, 'center');

    var tar_pic = arr_g[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];
    var temp_list = [];

    var res_data = "rand_red_in_green@" + tar_loc + "@" + tar_pic.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
    temp_list.push(res_data);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    var fake_pic = arr_r_remaining[Math.floor(Math.random() * 2)];
    var tar_loc2 = arr_loc_remaining[Math.floor(Math.random() * 4)];

    var res_data2 = "rand_red_in_green@" + tar_loc2 + "@" + fake_pic.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
    temp_list.push(res_data2);

    show_image(fake_pic, 250, 250, tar_loc2);
    var arr_loc_remaining2 = arr_loc_remaining.filter(function(value, index, arr) {
      return value != tar_loc2;
    });

    for (let i = 0; i < arr_loc_remaining2.length; i++) {
      var p = arr_g_remaining[Math.floor(Math.random() * 2)]
      var l = arr_loc_remaining2[i];

      var temp_data = "rand_red_in_green@" + l + "@" + p.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
      temp_list.push(temp_data);

      show_image(p, 250, 250, l);
    }
    display_list.push(temp_list.sort());

    controller = true;
    createdTime = Date.now();
  }

  async function rand_green_in_red() {
    clean_image();
    controller = false;
    
    show_image(dot, 250, 250, 'center');
    await sleep(sleep_time);
    clean_image();

    rand_canvas();
    await sleep(2 * sleep_time);
    clean_image();

    show_image(dot, 250, 250, 'center');
    await sleep(sleep_time);

    clean_image();
    show_image(dot, 250, 250, 'center');

    var tar_pic = arr_r[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];
    var temp_list = [];

    var res_data = "rand_green_in_red@" + tar_loc + "@" + tar_pic.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
    temp_list.push(res_data);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    var fake_pic = arr_g_remaining[Math.floor(Math.random() * 2)];
    var tar_loc2 = arr_loc_remaining[Math.floor(Math.random() * 4)];

    var res_data2 = "rand_green_in_red@" + tar_loc2 + "@" + fake_pic.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
    temp_list.push(res_data2);

    show_image(fake_pic, 250, 250, tar_loc2);

    var arr_loc_remaining2 = arr_loc_remaining.filter(function(value, index, arr) {
      return value != tar_loc2;
    });

    for (let i = 0; i < arr_loc_remaining2.length; i++) {
      var p = arr_r_remaining[Math.floor(Math.random() * 2)]
      var l = arr_loc_remaining2[i];

      var temp_data = "rand_green_in_red@" + l + "@" + p.match(/green_circle_hor|green_circle_ver|green_rec_hor|green_rec_ver|red_circle_hor|red_circle_ver|red_rec_hor|red_rec_ver/g);
      temp_list.push(temp_data);

      show_image(p, 250, 250, l);
    }
    display_list.push(temp_list.sort());

    controller = true;
    createdTime = Date.now();
  }

  function demoSeparateByCanvas(){
    if ($(window).width() >= 600 & screen.width * .8 < $(window).width()) {
      $('#instructions').hide();
      $('#frame6').show();
      // Begin
      $(document).on("keypress.trialWait", PressedKey0);

      function PressedKey0(evt) {
        evt.preventDefault();
        if (evt.which == 32) {
          trial_red_or_green();
        }
      }
    }
  }


  async function trial_red_or_green() {
    $(document).off("keypress.trialWait");
    $('#frame6').hide();
    $('#hor_ver').show();

    if (Math.floor(Math.random() * 2) == 0) {
      rand_red();
    } else {
      rand_green();
    }
    document.getElementById('trialNumber').innerHTML = trial_num++;
    $('#progressReport').show();

    $(document).on("keypress.trialWait", PressedKey7);

    function PressedKey7(evt) {
      evt.preventDefault();
      if (controller & (evt.which == Lkey | evt.which == Rkey)) {
        if (index < ctr_same_color-2) {
          res = evt.which == Rkey ? "vertical" : "horizontal";
          clickedTime = Date.now();
          time = clickedTime - createdTime;
          res_list.push(res);
          res_time.push(time);
          surprise_list.push(0);

          trial_red_or_green();
          index += 1;
        } 
        else if(system_idx - 1 > 0){
          res = evt.which == Rkey ? "vertical" : "horizontal";
          clickedTime = Date.now();
          time = clickedTime - createdTime;
          res_list.push(res);
          res_time.push(time);

          $(document).off("keypress.trialWait");
          $('#frame6').hide();
          $('#hor_ver').show();

          if (Math.floor(Math.random() * 2) == 0) {
            rand_green_in_red();
          } else {
            rand_red_in_green();
          }

          document.getElementById('trialNumber').innerHTML = trial_num++;
          $(document).on("keypress.trialWait", PressedKey7_0);

          function PressedKey7_0(evt) {
            evt.preventDefault();
            if (controller & (evt.which == Lkey | evt.which == Rkey)) {
              res = evt.which == Rkey ? "vertical" : "horizontal";
              clickedTime = Date.now();
              time = clickedTime - createdTime;
              res_list.push(res);
              res_time.push(time);
              surprise_list.push(1);

              index = 0//set index back to 0 to loop whole system
              system_idx -= 1;
              trial_red_or_green();
            } 
          }
        }
        else {
          res = evt.which == Rkey ? "vertical" : "horizontal";
          clickedTime = Date.now();
          time = clickedTime - createdTime;
          res_list.push(res);
          res_time.push(time);
          surprise_list.push(1);

          $(document).off("keypress.trialWait");
          $('#frame6').hide();
          $('#hor_ver').show();

          if (Math.floor(Math.random() * 2) == 0) {
            rand_green_in_red();
          } else {
            rand_red_in_green();
          }

          document.getElementById('trialNumber').innerHTML = trial_num++;
          //$('#progressReport').show();

          $(document).on("keypress.trialWait", PressedKey7_1);

          function PressedKey7_1(evt) {
            evt.preventDefault();
            if (controller & (evt.which == Lkey | evt.which == Rkey)) {
              res = evt.which == Rkey ? "vertical" : "horizontal";
              clickedTime = Date.now();
              time = clickedTime - createdTime;
              res_list.push(res);
              res_time.push(time);
              surprise_list.push(1);

              // clear index, for other loop cases uses
              index = 0;
              save();
            }
          }
        }
      }
    }
  }

  async function save() {
    $(document).off("keypress.trialWait");
    clean_image();
    $('#hor_ver').hide();
    $('#progressReport').hide();
    $('#Survey').show();

    show_image(color_blind_test, 250, 250, 'test_pic');
    }

    function checkValue(){
      var t1 = $("input:radio[name='Gender']").is(":checked");
      var t2 = $("input:radio[name='Ethnicity']").is(":checked");
      var t3 = $("input:radio[name='Race']").is(":checked");
      var t4 = !(isNaN(document.getElementById('testNumber').value) | (document.getElementById('testNumber').value == ""));
	    var t5 = !(isNaN(document.getElementById('ageNumber').value) | (document.getElementById('ageNumber').value == ""));
	  
      v1 = get_survey_value("Gender");
      v2 = get_survey_value("Ethnicity");
      v3 = get_survey_value("Race");
      v4 = document.getElementById('testNumber').value;
      v5 = document.getElementById('ageNumber').value;
      
      if(t1 & t2 & t3 & t4 & t5){
        Saved();
      }
      else{
        alert("Please fill all forms.");
      }
    }

  function Saved(){
    clean_image();
    $('#submitButton').hide();
    $('#Survey').hide();
    $('#done').show();
    SendToServer();
  }

  /* Send the data to the server as JSON: */
function SendToServer() {
	var curr_date = new Date();
	var curID = getParameterByName("id");
	dataToServer = {
	  'date': curr_date,
	  'result_list': JSON.stringify(res_list),
	  'result_time': JSON.stringify(res_time),
	  'display_info': JSON.stringify(display_list),
    'canvas_info': JSON.stringify(canvas_list),
	  'gender': v1,
	  'ethnicity': v2,
	  'race': v3,
	  'result_color_blind_test': (v4==8),
	  'number_color_blind_test': v4,
	  'age': v5,
	  'curID': curID,
	};
	var d = {
	  'id': getParameterByName("id"),
	  'experimenter': 'Kirsten',
	  'experimentName': 'ReactionTimeSepByCanvas',
	  'curData': JSON.stringify(dataToServer)
	};
	// $.post("http://serenceslab.ucsd.edu/experiments/RT_Exp/save.php",
	//   d,
	//   function(data) {
	// 	/* Get this from SONA by looking for the Completion URL (client-side) on SONA after creating an online SONA study: */
	// 	window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1661&credit_token=ab4560d23b684ec89438a7ec6fcee9b5&survey_code=" + getParameterByName("id");
	// 	console.log("Saved!");
	//   }
	// ).fail(function(data) {
	// 	/* Get this from SONA by looking for the Completion URL (client-side) on SONA after creating an online SONA study: */
	// 	window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1661&credit_token=ab4560d23b684ec89438a7ec6fcee9b5&survey_code=" + getParameterByName("id");
	// 	console.log("not saved!");
	// });

  //test logging
  console.log(d);
}
  
function getParameterByName(name, url) {
    if (!url) url = window.location.href;
       name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2]);
}




</script>
