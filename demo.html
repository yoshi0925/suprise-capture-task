<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://psyc241.ucsd.edu/Chaipat/TB_PCL_vWM_2AFC/js/vismemCC.js"></script>
<script src=""></script>

<style>
  .trialDiv {
    /* border: 2px solid gray;*/
    border: 0px;
    padding: auto;
    width: auto;
    position: relative;
    top: 50px;
    left: 50%;
    /* bring your own prefixes */
    transform: translate(-50%, -50%);
    text-align: center;
    display: none;
  }

  body {
    font-family: Arial, Helvetica;
    font-size: 12pt;
  }

  #submitButton {
    display: none;
  }

  #instructions {
    width: 60%;
    margin: 0 auto;
    text-align: center;
    margin-top: 100px;
  }

  #startExperiment {
    color: rgb(200, 200, 200);
    text-decoration: none;
  }

  #startExperiment:hover {
    color: white;
  }

  #startExperimentButton {
    width: 200px;
    text-align: center;
    border: 4px outset gray;
    background: gray;
    padding: 5px;
    margin: 0 auto;
  }

  #meter {
    width: 10cm;
    height: 10cm;
  }

  .instr {
    display: none;
  }

  .center-div {
    position: absolute;
    margin: auto;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    width: 320px;
    height: 100px;
  }

  #done {
    display: none;
  }
</style>

<div id="done" class="center-div">
  Saving data...
</div>

<input type="submit" value="Submit" name="submitButton" id="submitButton" style="position: absolute; margin: auto; top: 0; right: 0; bottom: 0; left: 0; width: 50px; height: 100px;">

<div id="instructions">
  <h2> Reaction Time Test </h2>
  <p>

    <p> <b> To proceed, please go fullscreen and your screen need to be bigger than 400 pixels </b>
      <br> Press <b>F11</b> to go full screen on a Windows PC
    </p>
    <p style="font:5px"> Clicking on the button will indicate that you have read this consent document and agree to participate. </p>

    <div id="startExperimentButton">
      <a href="#" id="startExperiment">I agree</a>
    </div>
    <p></p>

    <div id="consent" style="height:120px; border:1px solid #ccc;font:12px Arial, Helvetica; overflow:auto" align="justify">
      <p align="center"><b>UNIVERSITY OF CALIFORNIA, SAN DIEGO
          <br>CONSENT TO ACT AS A RESEARCH SUBJECT</b>

        <p> Dr. John Serences is conducting a research study to learn more about how attention affects how you see things
          (perception) and how you make simple decisions. There will be approximately 5,000 participants in the study
          over the next 10 years.</p>

        <p>
          <br><b>PROCEDURES.</b> If you agree to be in this study by clicking “Agree” and continuing to this task, the following
          will happen to you: You will be presented with stimuli that consist of simple shapes presented on a computer
          screen. You will respond with button presses and/or using your computer mouse.
          <p>
            <br> <b>RISKS.</b> You will be required only to continue to interact with your web browser and make responses for a short
            duration. Thus, no potential risks or discomforts are anticipated except for the possibility that some tasks may
            be slightly boring. However, there may be risks that are currently unforeseeable.</p>

          <p>
            <br><b>REMUNERATION.</b> In consideration of your time and effort you will receive extra course credit for your
            participation via the SONA system (0.5 credits per 30 minutes, rounded up to the nearest 30-minute increment).</p>

          <p>
            <br><b>RIGHTS.</b> If you are injured as a direct result of participation in this research, the University of California will
            provide any medical care you need to treat those injuries. The University will not provide any other form of
            compensation to you if you are injured. You may call the Human Research Protections Program at 858-246-

            4777 for more information about this, to inquire about your rights as a research subject, or to report research-
            related problems.</p>

          <p>
            <br><b>BENEFITS.</b> There will be no direct benefit to you from these procedures. However, the investigator may learn more about basic questions pertaining to attention, memory and vision. This knowledge may have benefits to society in
            fields
            ranging from improving education to visual design, but these benefits will be indirect.</p>

          <p>
            <br><b>EXPLANATION.</b> Dr. John Serences or a member of his research team has explained this study to you and
            answered your questions. If you have other questions or research-related problems, you may reach him at 858-
            534-3686. </p>
          <p>
            <br><b>VOLUNTARY NATURE OF PARTICIPATION.</b> Participation in this research is entirely voluntary. There is
            no cost to you for participating. The alternative to participating is not participating. You may refuse to
            participate or you may withdraw at any time without jeopardy to the medical care you will receive at this
            institution, without loss of any access to the care to which you are entitled, or loss of the benefits to which you
            are entitled. You may also be withdrawn from the study if the investigator feels it is in your best interest or for
            other study-related purposes. If you wish to withdraw from the study tell a member of the study staff and the
            testing session will terminate immediately. You will be compensated for the time you have spent.</p>

          <p>
            <br><b>CONFIDENTIALITY.</b> Research records will be kept confidential to the extent provided by law. Research
            records will only be accessible by Dr Serences and his research team, and by the UCSD Institutional Review
            Board. You have received a copy of this consent document.</p>

          <p>
            <br>By clicking “I agree”, you are indicating that you are at least 18 years old, have read this consent form and agree to participate in this research study. Please print a copy of this page for your records.</p>
        </p>
    </div>
</div>

<div id='frame1' ; class='trialDiv'>
  <p>On each trial, you'll see five shapes and need to identify direction of the line inside the diamond-shaped target as possible.
    <br> On each trial, there will be only one diamond shape. Press <b>"Z"</b> key if the line is horizontal, press <b>"M"</b> key if the line is vertical.
    <br> You will given 2 seconds for each trial.
    <br>Please keep your eyes at the dot in the middle.

    <br> <br> Please press <b>space bar</b> to continue.</p>
</div>

<!-- Target Absent Trial Demo -->
<div id='frame2' ; class='trialDiv'>
  <p>
    <br>
    <br> You may see something like this(pure green)
    <br> Your goal is to report which way the line is facing inside of the diamond-shaped target.
    <br> Please press <b>"Z"</b> if the line horizontal OR <b>"M"</b> if the line is vertical.
    <br> You will given 2 seconds for each trial.
    <br> <b>If the pictures are not complete, please maximaze the window.</b>

    <br> <br> Please press <b>"Z"</b> to choose the horizontal direction OR <b>"M"</b> to choose the vertical direction as your response.</p>
</div>

<div id='pic' ; style="float: left; clear: both; maring: 50px 0px 0px 0px;">
</div>

<!-- Target Present Trial Demo -->
<div id='frame3' ; class='trialDiv'>
  <p>
    <br> You may also see something like this(pure red)
    <br> Your goal is <b>the same</b> as previous: report which way the line is facing inside of the diamond-shaped target.
    <br> Please press <b>"Z"</b> if the line horizontal OR <b>"M"</b> if the line is vertical.

    <br> <br> Please press <b>"Z"</b> to choose the horizontal direction OR <b>"M"</b> to choose the vertical direction as your response.</p>
</div>

<!-- Target Present Trial Demo -->
<div id='frame4' ; class='trialDiv'>
  <p>
    <br> You may also see something like this(one red: red in green)
    <br> Your goal is <b>the same</b> as previous: report which way the line is facing inside of the diamond-shaped target.
    <br> Please press <b>"Z"</b> if the line horizontal OR <b>"M"</b> if the line is vertical.

    <br> <br> Please press <b>"Z"</b> to choose the horizontal direction OR <b>"M"</b> to choose the vertical direction as your response.</p>
</div>

<!-- Target Present Trial Demo -->
<div id='frame5' ; class='trialDiv'>
  <p>
    <br> You may also see something like this(one green: green in red)
    <br> Your goal is <b>the same</b> as previous: report which way the line is facing inside of the diamond-shaped target.
    <br> Please press <b>"Z"</b> if the line horizontal OR <b>"M"</b> if the line is vertical.

    <br> <br> Please press <b>"Z"</b> to choose the horizontal direction OR <b>"M"</b> to choose the vertical direction as your response.</p>
</div>

<div id='frame6' ; class='trialDiv'>
  <p>
    <br> The next trail will start after you make a response.
    <br> The sequence will always be like this.
    <br> Are you ready?
    <br> <br> Please press <b>any keys</b> to continue.</p>
</div>

<!-- Start page of every group of trials -->
<div id='frame7' ; class='trialDiv'>
  <p>
    <br> You can proceed to next round of trials when you are ready.
    <br> <br> Please press <b>any keys</b> to continue.</p>
</div>

<!-- Trial Page -->
<div id='hor_ver' ; class='trialDiv'>
  <p>
    <br> Press 'z' for horizontal, 'm' for vertical.</p>
</div>

<div id="progressReport" ; class='trialDiv'>
  Trial <span id="trialNumber">1</span> of <span id="totalTrialNumber">50</span>;
  <!-- THIS NUMBER WILL NEED TO BE CHANGED IF THE NUMBER OF TRIALS CHANGES -->
</div>


<!--Beginning of javascript code-->
<script>
  isTrain = false;
  $('#startExperiment').click(tutorial_1);
  $('.trialDiv').hide();

  // Global variables
  var Lkey = 122;
  var Rkey = 109;
  var timeToRespond = false; //this indicates whether or not the subject is allowed to respond with 'same' or 'different'
  var timeToMoveOn = true; //this indicates whether or not the subject is allowed to move on to the next trial

  var green_circle_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_circle_hor.png";
  var green_circle_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_circle_ver.png";
  var green_rec_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_rec_hor.png";
  var green_rec_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/green_rec_ver.png";
  var red_circle_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_circle_hor.png";
  var red_circle_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_circle_ver.png";
  var red_rec_hor = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_rec_hor.png";
  var red_rec_ver = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/red_rec_ver.png";
  var dot = "https://raw.githubusercontent.com/yoshi0925/suprise-capture-task/master/900px-Maya_1.svg.png";

  var arr_g = [green_rec_hor, green_rec_ver];
  var arr_r = [red_rec_hor, red_rec_ver];

  var arr_loc = ['top', 'mid_left', 'mid_right', 'bot_left', 'bot_right'];

  var arr_g_remaining = [green_circle_ver, green_circle_hor];
  var arr_r_remaining = [red_circle_ver, red_circle_hor];

  // same color mode run 5 times
  var ctr_same_color = 50;
  var trial_num = 1;

  //display_list to save the generated answere, res_list is the human answer
  var res_list = [];
  var display_list = [];
  var res = 0;

  // flags for random cases organization
  var g_flag = false;
  var r_flag = false;
  var mix_flag = false;

  // preload the images
  var imgSrcArr = [
    green_circle_hor,
    green_circle_ver,
    green_rec_hor,
    green_rec_ver,
    red_circle_hor,
    red_circle_ver,
    red_rec_hor,
    red_rec_ver,
    dot
  ];

  var imgWrap = [];

  function preloadImg(arr) {
    for (var i = 0; i < arr.length; i++) {
      imgWrap[i] = new Image();
      imgWrap[i].src = arr[i];
    }
  }

  preloadImg(imgSrcArr);

  //ms: millie seconds you want to sleep
  //usage: await sleep(200) in an async function
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function show_image(src, width, height, direction) {
    var img = document.createElement("img");
    img.src = src;
    if (direction == "top") {
      img.style = "position: absolute; top: 100px; left: 600px;"
    } else if (direction == "mid_right") {
      img.style = "position: absolute; top: 300px; left: 300px;"
    } else if (direction == "mid_left") {
      img.style = "position: absolute; top: 300px; left: 900px;"
    } else if (direction == "bot_left") {
      img.style = "position: absolute; top: 550px; left: 450px;"
    } else if (direction == 'center') {
      img.style = "position: absolute; top: 350; left: 600;"
    } else if (direction == "bot_right") {
      img.style = "position: absolute; top: 550px; left: 750px;"
    } else {
      var e = new Error('image location error, please check render codes');
      throw e
    }

    img.width = width;
    img.height = height;

    // This next line will just add it to the <div id='pic'> tag
    var pic_div = document.getElementById('pic');
    pic_div.appendChild(img);

  }

  function clean_image() {
    var div = document.getElementById('pic');
    while (div.firstChild) {
      div.removeChild(div.firstChild);
    }
  }

  async function rand_red() {
    clean_image();
    await sleep(100);
    show_image(dot, 250, 250, 'center');
    var tar_pic = arr_r[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];
    //TODO save tar_pic into an array to store randomized results, also in other rand_color functions
    res = tar_pic.includes('ver') ? 1 : 0;
    display_list.push(res);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    var i;
    for (i = 0; i < arr_loc_remaining.length; i++) {
      show_image(arr_r_remaining[Math.floor(Math.random() * 2)], 250, 250, arr_loc_remaining[i]);
    }
  }

  async function rand_green() {
    clean_image();
    await sleep(100);
    show_image(dot, 250, 250, 'center');

    var tar_pic = arr_g[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];

    res = tar_pic.includes('ver') ? 1 : 0;
    display_list.push(res);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    var i;
    for (i = 0; i < arr_loc_remaining.length; i++) {
      show_image(arr_g_remaining[Math.floor(Math.random() * 2)], 250, 250, arr_loc_remaining[i]);
    }
  }

  async function rand_red_in_green() {
    clean_image();
    await sleep(100);
    show_image(dot, 250, 250, 'center');

    var tar_pic = arr_g[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];

    res = tar_pic.includes('ver') ? 1 : 0;
    display_list.push(res);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    var fake_pic = arr_r_remaining[Math.floor(Math.random() * 2)];
    var tar_loc2 = arr_loc_remaining[Math.floor(Math.random() * 4)];

    show_image(fake_pic, 250, 250, tar_loc2);
    var arr_loc_remaining2 = arr_loc_remaining.filter(function(value, index, arr) {
      return value != tar_loc2;
    });

    var i;
    for (i = 0; i < arr_loc_remaining2.length; i++) {
      show_image(arr_g_remaining[Math.floor(Math.random() * 2)], 250, 250, arr_loc_remaining2[i]);
    }
  }

  async function rand_green_in_red() {
    clean_image();
    await sleep(100);
    show_image(dot, 250, 250, 'center');

    var tar_pic = arr_r[Math.floor(Math.random() * 2)];
    var tar_loc = arr_loc[Math.floor(Math.random() * 5)];

    res = tar_pic.includes('ver') ? 1 : 0;
    display_list.push(res);

    show_image(tar_pic, 250, 250, tar_loc);
    var arr_loc_remaining = arr_loc.filter(function(value, index, arr) {
      return value != tar_loc;
    });

    var fake_pic = arr_g_remaining[Math.floor(Math.random() * 2)];
    var tar_loc2 = arr_loc_remaining[Math.floor(Math.random() * 4)];
    show_image(fake_pic, 250, 250, tar_loc2);

    var arr_loc_remaining2 = arr_loc_remaining.filter(function(value, index, arr) {
      return value != tar_loc2;
    });

    var i;
    for (i = 0; i < arr_loc_remaining2.length; i++) {
      show_image(arr_r_remaining[Math.floor(Math.random() * 2)], 250, 250, arr_loc_remaining2[i]);
    }
  }

  function tutorial_1() {
    if ($(window).width() >= 600 & screen.width * .8 < $(window).width()) {
      $('#instructions').hide();
      $('#frame1').show();
      // Begin
      $(document).on("keypress.trialWait", PressedKey1);

      function PressedKey1(evt) {
        evt.preventDefault();
        if (evt.which == 32) {
          var redirect = Math.floor(Math.random() * 100);
          if (redirect >= 0 & redirect <= 24) { //pure green 25%
            g_flag = true;
            tutorial_2();
          } else if (redirect >= 25 & redirect <= 49) { //pure red 25%
            r_flag = true;
            tutorial_3();
          } else { //red_in_green + green_in_red 50%
            mix_flag = true;
            tutorial_4();
          }
        }
      }
    }
  }
  var index = 0;
  //pure green
  function tutorial_2() {
    $(document).off("keypress.trialWait");
    $('#frame1').hide();
    $('#frame2').show();
    rand_green();

    $(document).on("keypress.trialWait", PressedKey2);

    function PressedKey2(evt) {
      evt.preventDefault();
      if (evt.which == Lkey | evt.which == Rkey) {
        tutorial_6();
      }
    }
  }

  //pure red
  function tutorial_3() {
    $(document).off("keypress.trialWait");
    $('#frame1').hide();
    $('#frame3').show();
    rand_red();

    $(document).on("keypress.trialWait", PressedKey3);

    function PressedKey3(evt) {
      evt.preventDefault();
      if (evt.which == Lkey | evt.which == Rkey) {
        tutorial_6();
      }
    }
  }

  //one red
  function tutorial_4() {
    $(document).off("keypress.trialWait");
    $('#frame1').hide();
    $('#frame4').show();
    rand_red_in_green();

    $(document).on("keypress.trialWait", PressedKey4);

    function PressedKey4(evt) {
      evt.preventDefault();
      if (evt.which == Lkey | evt.which == Rkey) {
        tutorial_5();
      }
    }
  }


  //one green
  function tutorial_5() {
    $(document).off("keypress.trialWait");
    $('#frame4').hide();
    $('#frame5').show();
    rand_green_in_red();

    $(document).on("keypress.trialWait", PressedKey5);

    function PressedKey5(evt) {
      evt.preventDefault();
      if (evt.which == Lkey | evt.which == Rkey) {
        tutorial_6();
      }
    }
  }

  function tutorial_6() {
    $(document).off("keypress.trialWait");
    if (g_flag) {
      $('#frame2').hide();
    }
    if (r_flag) {
      $('#frame3').hide();
    }
    if (mix_flag) {
      $('#frame5').hide();
    }
    clean_image();
    $('#frame6').show();

    $(document).on("keypress.trialWait", PressedKey6);

    function PressedKey6(evt) {
      evt.preventDefault();
      if (evt.which == 32) {
        if (g_flag) {
          trial_pure_green();
        } else if (r_flag) {
          trial_pure_red();
        } else {
          trial_red_or_green();
        }
      }
    }
  }

  function trial_pure_green() {
    $(document).off("keypress.trialWait");
    $('#frame6').hide();
    $('#hor_ver').show();

    rand_green();

    document.getElementById('trialNumber').innerHTML = trial_num++;
    $('#progressReport').show();

    $(document).on("keypress.trialWait", PressedKey2);

    function PressedKey2(evt) {
      evt.preventDefault();
      if (evt.which == Lkey | evt.which == Rkey) {
        if (index < ctr_same_color-2) { //这个index可以改，现在的3意味着pure green执行4次，之后的redingreen一次，总共5次
          res = evt.which == Rkey ? 1 : 0;
          res_list.push(res);

          trial_pure_green();
          index += 1;
        } else { //这里为了防止重复call，从tutorial_5复制过来了一段，记得改frame hide/show和pressedKey
          $(document).off("keypress.trialWait");
          $('#frame6').hide();
          $('#hor_ver').show();

          document.getElementById('trialNumber').innerHTML = trial_num++;
          $('#progressReport').show();

          rand_red_in_green();

          $(document).on("keypress.trialWait", PressedKey2_1);

          function PressedKey2_1(evt) {
            evt.preventDefault();
            if (evt.which == Lkey | evt.which == Rkey) {
              res = evt.which == Rkey ? 1 : 0;
              res_list.push(res);
              //index改成0 方便之后用
              index = 0;
              AfterSuccessDataSaving();
            }
          }
        }
      }
    }
  }

  function trial_pure_red() {
    $(document).off("keypress.trialWait");
    $('#frame6').hide();
    $('#hor_ver').show();

    rand_red();

    document.getElementById('trialNumber').innerHTML = trial_num++;
    $('#progressReport').show();

    $(document).on("keypress.trialWait", PressedKey3);

    function PressedKey3(evt) {
      evt.preventDefault();
      if (evt.which == Lkey | evt.which == Rkey) {
        if (index < ctr_same_color-2) {
          res = evt.which == Rkey ? 1 : 0;
          res_list.push(res);

          trial_pure_red();
          index += 1;
        } else {
          $(document).off("keypress.trialWait");
          $('#frame6').hide();
          $('#hor_ver').show();

          rand_green_in_red();

          document.getElementById('trialNumber').innerHTML = trial_num++;
          $('#progressReport').show();

          $(document).on("keypress.trialWait", PressedKey3_1);

          function PressedKey3_1(evt) {
            evt.preventDefault();
            if (evt.which == Lkey | evt.which == Rkey) {
              res = evt.which == Rkey ? 1 : 0;
              res_list.push(res);
              //index改成0 方便之后用
              index = 0;
              AfterSuccessDataSaving();
            }
          }
        }
      }
    }
  }

  function trial_red_or_green() {
    $(document).off("keypress.trialWait");
    $('#frame1').hide();
    $('#frame2').hide();
    $('#frame3').hide();
    $('#frame4').hide();
    $('#frame5').hide();
    $('#frame6').hide();
    $('#hor_ver').show();

    if (Math.floor(Math.random() * 2) == 0) {
      rand_green_in_red();
    } else {
      rand_red_in_green();
    }
    document.getElementById('trialNumber').innerHTML = trial_num++;
    $('#progressReport').show();
    $(document).on("keypress.trialWait", PressedKey7);

    function PressedKey7(evt) {
      evt.preventDefault();
      if (ctr_same_color > 1 & (evt.which == Lkey | evt.which == Rkey)) {
        res = evt.which == Rkey ? 1 : 0;
        ctr_same_color -= 1;
        res_list.push(res);
        trial_red_or_green();
      } else if (ctr_same_color == 1) {
        AfterSuccessDataSaving();
      }
    }
  }



  function AfterSuccessDataSaving() {
    clean_image();
    $('#hor_ver').hide();
    $('#progressReport').hide();
    // After they are done, send them here:
    // window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1267&credit_token=805f6634de5a46b3aecffe2818d8d90c&survey_code=" + getParameterByName("code");
    $('#submitButton').show();
    $('#done').html("All done, thanks! Please click submit button.");
    $('#done').show();
    $('#')
    console.log("Saved!");
  }

  function AfterFailedSaving() {
    console.log("oops, failed to save");

    // window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1267&credit_token=805f6634de5a46b3aecffe2818d8d90c&survey_code=" + getParameterByName("code");
    $('#submitButton').show();
    $('#done').html("All done, thanks! Please click submit button.");

  }
</script>
